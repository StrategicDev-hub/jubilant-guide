<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>StoreCast ‚Äî Send Updates</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  <div class="max-w-2xl mx-auto p-4">
    <!-- Header -->
    <div class="flex items-center gap-3 mb-6">
      <img id="logoImg" class="h-14 w-14 rounded-full border shadow" src="" alt="Logo"/>
      <h1 id="shopTitle" class="text-2xl font-bold text-gray-800">StoreCast</h1>
    </div>

    <!-- Form -->
    <div class="bg-white shadow-md rounded-xl p-6">
      <label class="block text-sm font-medium">Headline</label>
      <input id="headline" class="w-full p-3 border rounded mt-1" placeholder="Festival Greetings / New Arrival"/>

      <label class="block text-sm font-medium mt-3">Price (optional)</label>
      <input id="price" class="w-full p-3 border rounded mt-1" placeholder="‚Çπ12,900 (if product)"/>

      <label class="block text-sm font-medium mt-3">Message (or use voice)</label>
      <textarea id="message" class="w-full p-3 border rounded mt-1 h-28" placeholder="Type or Speak..."></textarea>
      
      <div class="flex gap-2 mt-2">
        <button id="startVoice" class="px-4 py-2 bg-yellow-400 rounded shadow">üé§ Speak</button>
        <button id="stopVoice" class="px-4 py-2 bg-gray-200 rounded">‚ñ† Stop</button>
        <select id="lang" class="p-2 border rounded">
          <option value="hi-IN">Hindi</option>
          <option value="te-IN">Telugu</option>
          <option value="en-IN">English</option>
        </select>
      </div>

      <label class="block text-sm font-medium mt-3">Upload Product Image (optional)</label>
      <input type="file" id="imageFile" accept="image/*" class="w-full mt-1"/>
      <img id="preview" class="mt-3 rounded-lg shadow-sm hidden" style="max-width:100%"/>

      <div class="flex gap-3 mt-4">
        <button id="generateAI" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg">‚ú® Suggest (AI)</button>
        <button id="sendNow" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg">üöÄ Send</button>
      </div>
      <p id="status" class="text-sm mt-3 text-gray-600"></p>
    </div>

    <!-- Preview -->
    <div class="mt-6">
      <p class="text-sm text-gray-500">Preview:</p>
      <div id="phonePreview" class="border rounded-xl p-4 bg-white shadow hidden">
        <p class="text-lg font-semibold" id="previewHeadline"></p>
        <p id="previewMessage" class="mt-2 whitespace-pre-wrap"></p>
        <p id="previewPrice" class="mt-1 font-semibold text-yellow-700"></p>
        <img id="previewImg" class="mt-2 rounded hidden" style="max-width:220px"/>
        <p id="previewFooter" class="mt-3 text-gray-700 text-sm"></p>
      </div>
    </div>
  </div>

<script>
/* ------------------ CONFIG ------------------ */
const MAKE_WEBHOOK = "https://hook.eu2.make.com/yv5itn63eft9chv38vhdvil3mh86gfrl";
const CLOUD_NAME = "de5vsofvd";
const UPLOAD_PRESET = "storecast_upload";

/* Get shop from URL */
function getQueryParam(n){ return new URL(location.href).searchParams.get(n); }
const shop = getQueryParam("shop") || "demo-shop";
let shopConfig = {};

/* Fetch config (logo, shop name, phone) */
async function fetchConfig(){
  const res = await fetch(MAKE_WEBHOOK + "/fetch-config?shop=" + shop);
  shopConfig = await res.json();
  document.getElementById("shopTitle").textContent = shopConfig.shopName || "StoreCast";
  if(shopConfig.logoUrl) document.getElementById("logoImg").src = shopConfig.logoUrl;
}
fetchConfig();

/* Update Preview */
const ph = document.getElementById("phonePreview");
function updatePreview(){
  document.getElementById("previewHeadline").textContent = document.getElementById("headline").value;
  document.getElementById("previewMessage").textContent = document.getElementById("message").value;
  document.getElementById("previewPrice").textContent = document.getElementById("price").value;
  document.getElementById("previewFooter").textContent = "üìû " + (shopConfig.phone || "");
  ph.classList.remove("hidden");
}
["headline","message","price"].forEach(id=> document.getElementById(id).oninput=updatePreview);

/* Image preview */
document.getElementById("imageFile").onchange=(e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const url=URL.createObjectURL(f);
  document.getElementById("preview").src=url; document.getElementById("preview").classList.remove("hidden");
  document.getElementById("previewImg").src=url; document.getElementById("previewImg").classList.remove("hidden");
  updatePreview();
};

/* Voice input */
let rec;
document.getElementById("startVoice").onclick=()=>{
  const Rec=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!Rec){ alert("Browser not supported"); return;}
  rec=new Rec(); rec.lang=document.getElementById("lang").value; rec.interimResults=false;
  rec.onresult=(ev)=>{ document.getElementById("message").value=ev.results[0][0].transcript; updatePreview(); };
  rec.start(); document.getElementById("status").textContent="üé§ Listening...";
};
document.getElementById("stopVoice").onclick=()=>{ if(rec) rec.stop(); document.getElementById("status").textContent=""; };

/* Cloudinary upload */
async function upload(file){
  if(!file) return null;
  const url=`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
  const fd=new FormData(); fd.append("file",file); fd.append("upload_preset",UPLOAD_PRESET); fd.append("folder",shop);
  const r=await fetch(url,{method:"POST",body:fd}); return (await r.json()).secure_url;
}

/* AI Suggest */
document.getElementById("generateAI").onclick=async()=>{
  const body={shop,headline:headline.value,price:price.value,seedText:message.value,lang:lang.value};
  document.getElementById("status").textContent="Thinking...";
  const r=await fetch(MAKE_WEBHOOK+"/ai-suggest",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  if(r.ok){ const j=await r.json(); message.value=j.suggestion; updatePreview(); status.textContent="‚ú® AI ready"; }
  else status.textContent="AI failed";
};

/* Send */
document.getElementById("sendNow").onclick=async()=>{
  const f=imageFile.files[0]; const imgUrl=await upload(f);
  const body={shop,headline:headline.value,price:price.value,message:message.value,lang:lang.value,imageUrl:imgUrl};
  status.textContent="Sending...";
  const r=await fetch(MAKE_WEBHOOK+"/broadcast",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  if(r.ok) status.textContent="‚úÖ Sent to customers"; else status.textContent="‚ùå Failed";
};
</script>
</body>
</html>
